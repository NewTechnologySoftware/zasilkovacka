<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Osobní Evidence Zásilek | New Technology Software</title>
    <style>
        :root {
            --primary-green: #28a745;
            --primary-blue: #007bff;
            --text-dark: #333;
            --gray-light: #f4f4f4;
            --gray-border: #ccc;
            --gray-btn: #6c757d;
            --error-red: #dc3545;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        body { margin: 0; padding: 0; background-color: #f9f9f9; color: var(--text-dark); min-height: 100vh; display: flex; flex-direction: column; align-items: center; }

        /* --- Utility Classes --- */
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* --- Container --- */
        .container { width: 100%; max-width: 800px; background: white; padding: 30px; margin: 20px auto; border-radius: 12px; box-shadow: var(--shadow); position: relative; }

        /* --- Default / Error View --- */
        #default-view, #error-view { text-align: center; padding: 50px 20px; }
        #default-view h1, #error-view h1 { color: var(--primary-blue); margin-bottom: 20px; }
        #default-view p, #error-view p { color: #666; font-size: 1.1em; }
        
        /* Specific Error styling */
        #error-view h1 { color: var(--error-red); }

        /* --- Admin / Form View --- */
        h1.main-title { font-size: 24px; margin-bottom: 15px; color: var(--text-dark); }
        hr { border: 0; border-top: 1px solid #eee; margin: 20px 0; }
        p.subtitle { color: #666; margin-bottom: 20px; }

        .form-group { margin-bottom: 20px; position: relative; }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; }
        .input-wrapper { position: relative; }
        input[type="text"], input[type="date"], input[type="time"], select, .fake-select {
            width: 100%; padding: 12px; border: 1px solid var(--gray-border); border-radius: 6px; font-size: 16px; transition: border 0.3s; background: white; cursor: pointer;
        }
        input:focus { outline: none; border-color: var(--primary-blue); }
        .fake-select { background: #fff url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 8.825L1.175 4 2.238 2.938 6 6.7l3.763-3.762L10.825 4z'/%3E%3C/svg%3E") no-repeat right 15px center; }
        
        .helper-text { font-size: 12px; color: #666; margin-top: 4px; display: block; }
        .error-text { color: var(--error-red); font-size: 13px; margin-top: 5px; display: none; }
        
        .checkbox-group { display: flex; align-items: center; margin-top: 8px; font-size: 14px; }
        .checkbox-group input { margin-right: 8px; width: 18px; height: 18px; cursor: pointer; }

        /* --- Buttons --- */
        .btn { padding: 12px 24px; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:hover { opacity: 0.9; }
        .btn-green { background-color: var(--primary-green); color: white; width: 100%; margin-top: 20px; }
        .btn-gray { background-color: var(--gray-btn); color: white; }
        .btn-blue { background-color: var(--primary-blue); color: white; }
        .btn-small { padding: 8px 16px; width: auto; margin: 0 5px; }

        /* --- Modals / Overlays --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: 0.3s;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content {
            background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); transform: scale(0.9); transition: 0.3s; text-align: center;
        }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; }
        .modal-actions { margin-top: 20px; display: flex; justify-content: center; gap: 10px; }

        /* Specific Modal Styles */
        .option-list { list-style: none; padding: 0; margin: 0; text-align: left; }
        .option-list li { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s; }
        .option-list li:hover { background-color: #f0f8ff; color: var(--primary-blue); }
        .option-list li:last-child { border-bottom: none; }
        
        .radio-options label { display: block; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px; cursor: pointer; text-align: left; }
        .radio-options input { margin-right: 10px; }
        .radio-options label:hover { background-color: #f9f9f9; }

        .slide-up-input { overflow: hidden; max-height: 0; transition: max-height 0.5s ease; opacity: 0; }
        .slide-up-input.visible { max-height: 150px; opacity: 1; margin-top: 15px; }

        /* --- Warning Modal --- */
        .warning-icon { font-size: 40px; color: #ffc107; margin-bottom: 10px; display: block; }

        /* --- Label Preview (The "Wallet" Card) --- */
        #label-result-view { text-align: center; }
        .label-card {
            border: 3px solid black;
            border-radius: 15px;
            padding: 15px;
            margin: 20px auto;
            text-align: left;
            max-width: 600px; /* Wallet landscape preference */
            background: white;
            color: black;
            position: relative;
        }

        .label-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 4px; flex-wrap: wrap; }
        .label-text { font-size: 14px; font-weight: 500; }
        .label-big { font-size: 26px; font-weight: 800; }
        .label-note { font-size: 12px; color: #000; margin-top: 2px; }
        
        .label-actions { display: flex; gap: 10px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }

        /* --- View Only Mode Styles --- */
        .view-only-msg { margin-top: 15px; font-size: 13px; color: #666; max-width: 500px; margin-left: auto; margin-right: auto; }
        .copy-link-container { display: flex; gap: 10px; align-items: center; justify-content: center; margin-top: 10px; flex-wrap: wrap; }
        .generated-link { font-family: monospace; background: #eee; padding: 8px; border-radius: 4px; word-break: break-all; font-size: 12px; }

        /* --- Print Media Query --- */
        @media print {
            body * { visibility: hidden; }
            .label-card, .label-card * { visibility: visible; }
            .label-card { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 100%; max-width: 100%; border-width: 2px; }
        }

        /* --- Mobile Responsiveness --- */
        @media (max-width: 600px) {
            .container { padding: 15px; margin: 10px; width: calc(100% - 20px); }
            /* .label-row { flex-direction: column; }  <-- Removed to allow side-by-side flex for big numbers */
            .label-big { font-size: 20px; }
        }
    </style>
</head>
<body>

    <div id="default-view" class="container hidden">
        <h1>U New Technology Software jste správně</h1>
        <p>Bohužel jsme ale nerozpoznali stránku, kterou jste chtěli načíst. Zkontrolujte, zda máte správně zadanou URL adresu.</p>
    </div>

    <div id="error-view" class="container hidden">
        <h1>New Technology Software 404</h1>
        <p>Došlo k chybě a nepodařilo se spárovat ID a server package data transformer. Chyba je na Vaší straně - zadaný odkaz obsahuje chybu. Zkontrolujte jej prosím. Pokus o nápravu: Zdá se, že jste se pokusili přistoupit k serveru NTS/Osobni_Evidence_Zasilek a načíst data ze zasilkovacka. Pokud je to správně, ujistěte se, že jste zadali URL ve tvaru: https://newtechnologysoftware.github.io/ zasilkovacka/#zasilka-online-stitek/id?, kde namísto ? zadáte správné ID zásilky pro zobrazení štítku o zásilce k vyzvednutí. Pokud to stále nefunguje, Vaše ID zásilky je nesprávné. Pokud Vám bylo zasláno formou "Tato zásilka je připravena k vyzvednutí, prosím o vyzvednutí" a odkaz nefunguje, znamená to, že zpráva byla zaslána předčasně. Zásilka zatím není ve stavu "Připraveno na vyzvednutí". Vraťte se sem později...</p>
    </div>

    <div id="admin-view" class="container hidden">
        <h1 class="main-title">Vytvoření štítku pro vyzvednutí balíku</h1>
        <hr>
        <p class="subtitle">Vyplňte následující údaje, aby byl štítek vygenerován:</p>

        <div class="form-group">
            <label>Kurýrní společnost:</label>
            <input type="text" id="courier-input" class="fake-select" placeholder="Vyberte dopravce..." readonly>
        </div>

        <div class="form-group">
            <label>Typ doručení:</label>
            <input type="text" id="delivery-type-input" class="fake-select" placeholder="Vyberte typ doručení..." readonly>
        </div>

        <div id="dynamic-form-part-1" class="hidden fade-in">
            <hr>
            
            <div id="address-date-section" class="hidden">
                <div class="form-group">
                    <label>Termín doručení na adresu:</label>
                    <span class="helper-text" style="margin-bottom:5px;">* Termín by měl vycházet z informací od kurýra = již potvrzené datum a čas!</span>
                    <input type="date" id="address-date">
                </div>
                <div id="address-time-container" class="hidden fade-in">
                    <label>Časový rozsah příjezdu kurýra:</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 5px;" id="time-inputs">
                        <input type="time" id="time-from" aria-label="Od">
                        <input type="time" id="time-to" aria-label="Do">
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="no-time-check">
                        <label for="no-time-check">Kurýr neuvedl časový rozsah.</label>
                    </div>
                </div>
            </div>

            <div id="pickup-date-section" class="hidden">
                <div class="form-group">
                    <label>Do kdy je zásilka uložena na výdejním místě / v boxu:</label>
                    <input type="date" id="pickup-date">
                </div>
            </div>
        </div>

        <div id="dynamic-form-part-2" class="hidden fade-in">
            <div class="form-group">
                <label>Číslo objednávky (Zásilka):</label>
                <input type="text" id="order-number">
            </div>
            <div class="form-group">
                <label>PIN kód pro vyzvednutí:</label>
                <input type="text" id="pin-code">
            </div>
            <div class="form-group">
                <label>Interní poznámka:</label>
                <input type="text" id="internal-note">
                <div class="checkbox-group">
                    <input type="checkbox" id="no-note-check">
                    <label for="no-note-check">Neuvádět</label>
                </div>
            </div>
            <div class="form-group">
                <label>Telefonní číslo na balíku:</label>
                <input type="text" id="phone-number">
            </div>
            <div class="form-group">
                <label>Jméno a příjmení příjemce balíku:</label>
                <input type="text" id="recipient-name">
            </div>
            <div class="form-group">
                <label>Platba dobírkou:</label>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <input type="text" id="cod-amount"> <span>Kč</span>
                </div>
                <span class="error-text" id="cod-error">Je možné zadat pouze kladná čísla!</span>
                <div class="checkbox-group">
                    <input type="checkbox" id="no-cod-check">
                    <label for="no-cod-check">Bez dobírky. Uhrazeno.</label>
                </div>
            </div>

            <button id="btn-generate" class="btn btn-green">Generovat &rarr;</button>
        </div>
        
        <div id="placeholder-text">
            <hr>
            <p style="color: #999; font-style: italic;">Vyplňte požadované údaje výše...</p>
        </div>
    </div>

    <div id="label-result-view" class="container hidden">
        <h1 id="label-page-title" class="main-title">Štítek pro vyzvednutí zásilky</h1>
        <p id="label-page-subtitle" class="subtitle">Náhled:</p>

        <div class="label-card">
            <div class="label-row">
                <span class="label-text" id="lbl-transport">Způsob dopravy: ...</span>
                <span class="label-text" id="lbl-provider">Dodavatel: ...</span>
            </div>
            <div class="label-row" style="margin-top: 10px; align-items: center; justify-content: flex-start; gap: 15px;">
                <span class="label-text">Zásilka: </span>
                <span class="label-big" id="lbl-shipment">XX</span>
            </div>
            <div class="label-row" style="align-items: center; justify-content: flex-start; gap: 15px;">
                <span class="label-text">PIN: </span>
                <span class="label-big" id="lbl-pin">XX</span>
            </div>
            <div style="margin-top: 10px;">
                <div class="label-row">
                    <span class="label-text" id="lbl-date-line">Uložena do: ...</span>
                </div>
                <div id="lbl-time-note" class="label-note hidden">Přesný čas nezadán.</div>
            </div>
            <div style="margin-top: 10px; border-top: 1px dashed #ccc; padding-top: 5px;">
                <div class="label-row"><span class="label-text">Telefonní číslo: <span id="lbl-phone" style="font-weight:400"></span></span></div>
                <div class="label-row"><span class="label-text">Příjemce: <span id="lbl-recipient" style="font-weight:400"></span></span></div>
                <div class="label-row" id="row-note"><span class="label-text">Interní poznámka: <span id="lbl-note" style="font-weight:400"></span></span></div>
                <div class="label-row"><span class="label-text">Dobírka: <span id="lbl-cod"></span></span></div>
            </div>
        </div>

        <div class="label-actions">
            <button id="btn-print" class="btn btn-green">Vytisknout</button>
            <button id="btn-save-share" class="btn btn-blue">Uložit online a sdílet</button>
        </div>
        
        <div id="view-mode-info" class="hidden">
            <p class="view-only-msg">Pokud chcete štítek tisknout, sdílet, upravovat nebo provádět jiné akce, přejděte na admin panel a přihlaste se do systému Osobní Evidence zásilek!</p>
        </div>
        
        <div id="share-link-area" class="hidden fade-in">
            <div class="copy-link-container">
                <span id="share-url" class="generated-link">...</span>
                <button id="btn-copy" class="btn btn-blue btn-small">Zkopírovat</button>
            </div>
        </div>
    </div>


    <div id="modal-courier" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title">Vyberte kurýrní společnost</div>
            <ul class="option-list" id="courier-list">
                </ul>
        </div>
    </div>

    <div id="modal-custom-input" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title" id="custom-modal-title">Jiný dopravce</div>
            <p id="custom-modal-text">Zadejte jiného dopravce:</p>
            <input type="text" id="custom-input-field">
            <div class="modal-actions">
                <button class="btn btn-gray btn-small" id="btn-custom-back">Zpět</button>
                <button class="btn btn-green btn-small" id="btn-custom-confirm">Potvrdit</button>
            </div>
        </div>
    </div>

    <div id="modal-delivery-type" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title">Typ doručení</div>
            <ul class="option-list" id="delivery-list">
                </ul>
        </div>
    </div>

    <div id="modal-address" class="modal-overlay">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-title">Doručení na adresu:</div>
            <p>Zvolte adresu doručení:</p>
            <div class="radio-options">
                <label><input type="radio" name="addr-radio" value="Čertoryje 226"> Čertoryje 226</label>
                <label><input type="radio" name="addr-radio" value="Čertoryje 227"> Čertoryje 227</label>
                <label><input type="radio" name="addr-radio" value="Jiná"> Jiná</label>
            </div>
            
            <div id="custom-addr-container" class="slide-up-input">
                <p>Zadejte prosím konkrétní adresu:</p>
                <input type="text" id="custom-addr-input">
            </div>

            <div class="modal-actions">
                <button class="btn btn-gray btn-small" id="btn-addr-back">Zpět</button>
                <button class="btn btn-green btn-small hidden" id="btn-addr-confirm">Potvrdit</button>
            </div>
        </div>
    </div>

    <div id="modal-warning" class="modal-overlay">
        <div class="modal-content">
            <span class="warning-icon">⚠️</span>
            <div class="modal-title">Upozornění</div>
            <p>Je potřeba vyplnit všechna pole nebo využít zaškrtávací možnosti!</p>
            <button class="btn btn-blue btn-small" style="margin-top:15px;" onclick="closeWarning()">Rozumím</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB7ss5yYyswMgeh7QBtbmNAG7_DAZEjlIg",
            authDomain: "stitky-zasilky-vyzvednout.firebaseapp.com",
            databaseURL: "https://stitky-zasilky-vyzvednout-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "stitky-zasilky-vyzvednout",
            storageBucket: "stitky-zasilky-vyzvednout.firebasestorage.app",
            messagingSenderId: "495288570389",
            appId: "1:495288570389:web:f25a393cf94855c4b6341c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- GLOBAL STATE ---
        let currentMode = 'default'; // default, admin, view, error
        let formData = {
            courier: '',
            deliveryType: '',
            isAddress: false,
            date: '',
            timeFrom: '',
            timeTo: '',
            noTime: false,
            orderNum: '',
            pin: '',
            note: '',
            noNote: false,
            phone: '',
            recipient: '',
            cod: '',
            noCod: false
        };

        // --- DOM ELEMENTS ---
        const views = {
            default: document.getElementById('default-view'),
            admin: document.getElementById('admin-view'),
            label: document.getElementById('label-result-view'),
            error: document.getElementById('error-view')
        };
        const inputs = {
            courier: document.getElementById('courier-input'),
            type: document.getElementById('delivery-type-input'),
            addressDate: document.getElementById('address-date'),
            pickupDate: document.getElementById('pickup-date'),
            timeFrom: document.getElementById('time-from'),
            timeTo: document.getElementById('time-to'),
            noTime: document.getElementById('no-time-check'),
            order: document.getElementById('order-number'),
            pin: document.getElementById('pin-code'),
            note: document.getElementById('internal-note'),
            noNote: document.getElementById('no-note-check'),
            phone: document.getElementById('phone-number'),
            recipient: document.getElementById('recipient-name'),
            cod: document.getElementById('cod-amount'),
            noCod: document.getElementById('no-cod-check'),
            codError: document.getElementById('cod-error')
        };

        // --- ROUTING ---
        function handleRouting() {
            const hash = window.location.hash;
            hideAllViews();

            if (hash === '#admin-main') {
                currentMode = 'admin';
                views.admin.classList.remove('hidden');
            } else if (hash.startsWith('#zasilka-online-stitek/')) {
                currentMode = 'view';
                const id = hash.split('/')[1];
                loadLabelFromDb(id);
            } else {
                currentMode = 'default';
                views.default.classList.remove('hidden');
            }
        }

        function hideAllViews() {
            Object.values(views).forEach(el => el.classList.add('hidden'));
        }

        window.addEventListener('load', handleRouting);
        window.addEventListener('hashchange', handleRouting);

        // --- ADMIN FORM LOGIC ---

        // Data Lists - Updated
        const couriers = ["Zásilkovna", "Balíkovna", "Česká pošta", "PPL", "DPD", "One by Allegro / WE|DO", "Alza", "Datart", "Jiné"];
        const deliveryTypes = [
            "DZ Oil Dub nad Moravou výdejní místo Allwyn Group", 
            "Zásilkovna GigaComputer Olomouc", 
            "MO - Potraviny Lenka", 
            "Pobočka Pošta Šantovka", 
            "AlzaBox Šantovka", 
            "AlzaBox Šumperk (Kaufland)", 
            "Na adresu", 
            "Jiné"
        ];

        // Modal Helpers
        const openModal = (id) => document.getElementById(id).classList.add('active');
        const closeModal = (id) => document.getElementById(id).classList.remove('active');

        // 1. Courier Handling
        inputs.courier.addEventListener('click', () => {
            const list = document.getElementById('courier-list');
            list.innerHTML = '';
            couriers.forEach(c => {
                const li = document.createElement('li');
                li.textContent = c;
                li.onclick = () => selectCourier(c);
                list.appendChild(li);
            });
            openModal('modal-courier');
        });

        function selectCourier(val) {
            closeModal('modal-courier');
            if (val === 'Jiné') {
                setupCustomModal("Jiný dopravce", "Zadejte jiného dopravce:", (text) => {
                    inputs.courier.value = text;
                    formData.courier = text;
                    checkDynamicParts();
                });
            } else {
                inputs.courier.value = val;
                formData.courier = val;
                checkDynamicParts();
            }
        }

        // 2. Delivery Type Handling
        inputs.type.addEventListener('click', () => {
            const list = document.getElementById('delivery-list');
            list.innerHTML = '';
            deliveryTypes.forEach(t => {
                const li = document.createElement('li');
                li.textContent = t;
                li.onclick = () => selectDeliveryType(t);
                list.appendChild(li);
            });
            openModal('modal-delivery-type');
        });

        function selectDeliveryType(val) {
            closeModal('modal-delivery-type');
            if (val === 'Jiné') {
                setupCustomModal("Zadat typ doručení:", "Zadejte místo, kde je zásilka připravena na vyzvednutí:", (text) => {
                    inputs.type.value = text;
                    formData.deliveryType = text;
                    formData.isAddress = false;
                    checkDynamicParts();
                });
            } else if (val === 'Na adresu') {
                openAddressModal();
            } else {
                inputs.type.value = val;
                formData.deliveryType = val;
                formData.isAddress = false;
                checkDynamicParts();
            }
        }

        // Custom Modal Logic
        let customConfirmCallback = null;
        function setupCustomModal(title, text, callback) {
            document.getElementById('custom-modal-title').textContent = title;
            document.getElementById('custom-modal-text').textContent = text;
            document.getElementById('custom-input-field').value = '';
            customConfirmCallback = callback;
            openModal('modal-custom-input');
        }

        document.getElementById('btn-custom-back').onclick = () => {
            closeModal('modal-custom-input');
        };
        document.getElementById('btn-custom-confirm').onclick = () => {
            const val = document.getElementById('custom-input-field').value;
            if(val.trim() !== "") {
                if(customConfirmCallback) customConfirmCallback(val);
                closeModal('modal-custom-input');
            }
        };

        // Address Modal Logic
        function openAddressModal() {
            // Reset state
            document.querySelectorAll('input[name="addr-radio"]').forEach(r => r.checked = false);
            document.getElementById('custom-addr-input').value = '';
            document.getElementById('custom-addr-container').classList.remove('visible');
            document.getElementById('btn-addr-confirm').classList.add('hidden');
            openModal('modal-address');
        }

        const addrRadios = document.querySelectorAll('input[name="addr-radio"]');
        addrRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                const confirmBtn = document.getElementById('btn-addr-confirm');
                const customContainer = document.getElementById('custom-addr-container');
                
                if (e.target.value === 'Jiná') {
                    confirmBtn.classList.add('hidden'); // wait for input
                    customContainer.classList.add('visible');
                } else {
                    customContainer.classList.remove('visible');
                    confirmBtn.classList.remove('hidden');
                }
            });
        });

        document.getElementById('custom-addr-input').addEventListener('input', (e) => {
            const confirmBtn = document.getElementById('btn-addr-confirm');
            if (e.target.value.trim().length > 0) {
                confirmBtn.classList.remove('hidden');
            } else {
                confirmBtn.classList.add('hidden');
            }
        });

        document.getElementById('btn-addr-back').onclick = () => closeModal('modal-address');
        document.getElementById('btn-addr-confirm').onclick = () => {
            const selected = document.querySelector('input[name="addr-radio"]:checked').value;
            let finalAddr = "";
            if (selected === 'Jiná') {
                finalAddr = document.getElementById('custom-addr-input').value;
            } else {
                finalAddr = selected;
            }
            inputs.type.value = "Na adresu - " + finalAddr;
            formData.deliveryType = inputs.type.value;
            formData.isAddress = true;
            checkDynamicParts();
            closeModal('modal-address');
        };


        // 3. Dynamic Form Parts
        function checkDynamicParts() {
            const part1 = document.getElementById('dynamic-form-part-1');
            const placeholder = document.getElementById('placeholder-text');
            const addrSec = document.getElementById('address-date-section');
            const pickSec = document.getElementById('pickup-date-section');

            if (inputs.courier.value && inputs.type.value) {
                placeholder.classList.add('hidden');
                part1.classList.remove('hidden');

                if (formData.isAddress) {
                    addrSec.classList.remove('hidden');
                    pickSec.classList.add('hidden');
                } else {
                    addrSec.classList.add('hidden');
                    pickSec.classList.remove('hidden');
                }
            }
        }

        // Date/Time Logic
        inputs.addressDate.addEventListener('change', () => {
            document.getElementById('address-time-container').classList.remove('hidden');
            // If date is filled, allow showing part 2
            checkPart2();
        });
        
        inputs.pickupDate.addEventListener('change', () => {
            checkPart2();
        });

        inputs.noTime.addEventListener('change', (e) => {
            const inputsDiv = document.getElementById('time-inputs');
            if (e.target.checked) {
                inputsDiv.classList.add('hidden');
                formData.noTime = true;
            } else {
                inputsDiv.classList.remove('hidden');
                formData.noTime = false;
            }
        });

        function checkPart2() {
            const part2 = document.getElementById('dynamic-form-part-2');
            let ready = false;
            if (formData.isAddress) {
                if (inputs.addressDate.value) ready = true;
            } else {
                if (inputs.pickupDate.value) ready = true;
            }
            
            if (ready) part2.classList.remove('hidden');
        }


        // 4. Final Fields Logic
        inputs.noNote.addEventListener('change', (e) => {
            if (e.target.checked) {
                inputs.note.classList.add('hidden');
                inputs.note.value = '';
                formData.noNote = true;
            } else {
                inputs.note.classList.remove('hidden');
                formData.noNote = false;
            }
        });

        inputs.noCod.addEventListener('change', (e) => {
            if (e.target.checked) {
                inputs.cod.classList.add('hidden');
                inputs.cod.value = '';
                inputs.codError.style.display = 'none';
                formData.noCod = true;
            } else {
                inputs.cod.classList.remove('hidden');
                formData.noCod = false;
            }
        });

        inputs.cod.addEventListener('input', (e) => {
            const val = e.target.value;
            // Regex for positive numbers
            if (/[^0-9.]/.test(val) || (val !== "" && parseFloat(val) < 0)) {
                inputs.codError.style.display = 'block';
                e.target.value = val.replace(/[^0-9]/g, ''); 
            } else {
                inputs.codError.style.display = 'none';
            }
        });


        // 5. Generate & Validation
        document.getElementById('btn-generate').addEventListener('click', () => {
            // Collect Data
            formData.date = formData.isAddress ? inputs.addressDate.value : inputs.pickupDate.value;
            formData.timeFrom = inputs.timeFrom.value;
            formData.timeTo = inputs.timeTo.value;
            formData.orderNum = inputs.order.value;
            formData.pin = inputs.pin.value;
            formData.note = inputs.note.value;
            formData.phone = inputs.phone.value;
            formData.recipient = inputs.recipient.value;
            formData.cod = inputs.cod.value;

            if (validate()) {
                generateLabel(formData);
                views.admin.classList.add('hidden');
                views.label.classList.remove('hidden');
                
                // Set View Mode specific UI for Admin
                document.getElementById('btn-print').style.display = 'inline-flex';
                document.getElementById('btn-save-share').style.display = 'inline-flex';
                document.getElementById('view-mode-info').classList.add('hidden');
                document.getElementById('btn-save-share').disabled = false;
                document.getElementById('btn-save-share').classList.remove('btn-gray');
                document.getElementById('btn-save-share').classList.add('btn-blue');
            } else {
                openModal('modal-warning');
            }
        });

        window.closeWarning = () => closeModal('modal-warning');

        function validate() {
            if (!formData.courier || !formData.deliveryType) return false;
            if (formData.isAddress) {
                if (!formData.date) return false;
                if (!formData.noTime && (!formData.timeFrom || !formData.timeTo)) return false;
            } else {
                if (!formData.date) return false;
            }

            if (!formData.orderNum || !formData.pin || !formData.phone || !formData.recipient) return false;
            if (!formData.noNote && !formData.note) return false;
            if (!formData.noCod && !formData.cod) return false;

            return true;
        }


        // 6. Label Generation Render
        function generateLabel(data) {
            document.getElementById('lbl-transport').textContent = "Způsob dopravy: " + data.deliveryType;
            
            document.getElementById('lbl-provider').textContent = "Dodavatel: " + data.courier;
            document.getElementById('lbl-shipment').textContent = data.orderNum;
            document.getElementById('lbl-pin').textContent = data.pin;

            if (data.isAddress) {
                let timeStr = "";
                if (data.noTime) {
                    timeStr = "";
                    document.getElementById('lbl-time-note').classList.remove('hidden');
                } else {
                    timeStr = `, ${data.timeFrom}:${data.timeTo}`;
                    document.getElementById('lbl-time-note').classList.add('hidden');
                }
                document.getElementById('lbl-date-line').textContent = `Doručení v: ${formatDate(data.date)}${timeStr}`;
            } else {
                document.getElementById('lbl-date-line').textContent = `Uložena do: ${formatDate(data.date)}`;
                document.getElementById('lbl-time-note').classList.add('hidden');
            }

            document.getElementById('lbl-phone').textContent = data.phone;
            document.getElementById('lbl-recipient').textContent = data.recipient;

            if (data.noNote) {
                document.getElementById('row-note').classList.add('hidden');
            } else {
                document.getElementById('row-note').classList.remove('hidden');
                document.getElementById('lbl-note').textContent = data.note;
            }

            if (data.noCod) {
                document.getElementById('lbl-cod').textContent = "Bez dobírky";
                document.getElementById('lbl-cod').style.fontSize = "14px";
                document.getElementById('lbl-cod').style.fontWeight = "400";
            } else {
                document.getElementById('lbl-cod').textContent = data.cod + " Kč";
                document.getElementById('lbl-cod').style.fontSize = "22px";
                document.getElementById('lbl-cod').style.fontWeight = "bold";
            }
        }

        function formatDate(dateStr) {
            // YYYY-MM-DD -> DD.MM.YYYY
            if(!dateStr) return "";
            const [y, m, d] = dateStr.split('-');
            return `${d}.${m}.${y}`;
        }


        // 7. Actions: Print & Save
        document.getElementById('btn-print').addEventListener('click', () => {
            window.print();
        });

        document.getElementById('btn-save-share').addEventListener('click', async () => {
            const btn = document.getElementById('btn-save-share');
            btn.textContent = "Ukládám...";
            
            // Generate Random ID
            const newId = Math.random().toString(36).substr(2, 9);
            
            try {
                await set(ref(db, 'labels/' + newId), formData);
                
                const link = `https://newtechnologysoftware.github.io/zasilkovacka/#zasilka-online-stitek/id${newId}`;
                document.getElementById('share-url').textContent = link;
                document.getElementById('share-link-area').classList.remove('hidden');
                
                btn.textContent = "Uloženo";
                btn.disabled = true;
                btn.classList.add('btn-gray');
                btn.classList.remove('btn-blue');

            } catch (error) {
                console.error(error);
                alert("Chyba při ukládání: " + error.message);
                btn.textContent = "Uložit online a sdílet";
            }
        });

        document.getElementById('btn-copy').addEventListener('click', () => {
            const text = document.getElementById('share-url').textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert("Odkaz zkopírován do schránky!");
            });
        });


        // 8. VIEW MODE LOGIC (Fetching data)
        async function loadLabelFromDb(rawId) {
            // Remove 'id' prefix if present
            const id = rawId.replace('id', '');
            
            // Hide Actions initially
            const btnPrint = document.getElementById('btn-print');
            const btnSave = document.getElementById('btn-save-share');
            
            try {
                const snapshot = await get(child(ref(db), `labels/${id}`));
                if (snapshot.exists()) {
                    views.label.classList.remove('hidden'); // Show Label
                    const data = snapshot.val();
                    
                    // Modify Titles for View Mode
                    document.getElementById('label-page-title').textContent = "Online štítek pro vyzvednutí zásilky";
                    document.getElementById('label-page-subtitle').textContent = "Vygenerováno v systému New Technology Software Osobní Evidence zásilek:";
                    
                    generateLabel(data);
                    
                    // Disable buttons
                    btnPrint.classList.add('btn-gray', 'disabled');
                    btnPrint.style.pointerEvents = 'none';
                    btnPrint.style.opacity = '0.6';
                    
                    btnSave.textContent = "Uložit online a sdílet";
                    btnSave.classList.add('btn-gray');
                    btnSave.classList.remove('btn-blue');
                    btnSave.disabled = true;
                    btnSave.style.pointerEvents = 'none';

                    document.getElementById('view-mode-info').classList.remove('hidden');

                } else {
                    // Specific 404 logic
                    views.label.classList.add('hidden');
                    views.error.classList.remove('hidden'); // Show 404
                }
            } catch (error) {
                console.error(error);
                // In case of network error, show 404 or alert
                views.label.classList.add('hidden');
                views.error.classList.remove('hidden');
            }
        }

    </script>
</body>
</html>


