<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Osobní Evidence Zásilek - New Technology Software</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #333;
            --accent-green: #28a745;
            --accent-blue: #007bff;
            --accent-red: #dc3545;
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --border-radius: 8px;
            --shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Roboto', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 0; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }

        /* --- GLOBAL LAYOUT --- */
        .container { width: 100%; max-width: 800px; background: white; padding: 30px; border-radius: var(--border-radius); box-shadow: var(--shadow); margin: 20px 0; display: none; }
        .active-view { display: block; animation: fadeIn 0.5s ease; }

        h1 { font-size: 24px; font-weight: 700; margin-bottom: 10px; text-align: center; }
        h2 { font-size: 18px; font-weight: 500; margin-bottom: 20px; color: #555; text-align: center; }
        hr { border: 0; border-top: 1px solid #ddd; margin: 20px 0; }
        
        .section-hidden { display: none; opacity: 0; }
        .section-visible { display: block; opacity: 1; animation: slideDown 0.5s ease; }

        /* --- FORMS --- */
        .form-group { margin-bottom: 15px; position: relative; }
        label { display: block; font-weight: 500; margin-bottom: 5px; font-size: 14px; }
        
        input[type="text"], input[type="date"], input[type="time"], .custom-select-trigger {
            width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 15px; transition: border 0.3s; background: white;
        }
        
        /* Custom Select */
        .custom-select-wrapper { position: relative; cursor: pointer; }
        .custom-select-trigger { cursor: pointer; background: white url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"><path fill="gray" d="M7 10l5 5 5-5z"/></svg>') no-repeat right 12px center; }
        .custom-options {
            position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; 
            border-radius: 0 0 6px 6px; z-index: 100; max-height: 200px; overflow-y: auto; display: none; box-shadow: 0 5px 10px rgba(0,0,0,0.1);
        }
        .custom-options.open { display: block; }
        .custom-option { padding: 10px 15px; cursor: pointer; transition: background 0.2s; }
        .custom-option:hover { background-color: #f1f1f1; }

        .checkbox-wrapper { display: flex; align-items: center; margin-top: 5px; font-size: 14px; }
        .checkbox-wrapper input { margin-right: 8px; width: auto; }

        /* --- BUTTONS --- */
        .btn { padding: 12px 25px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 600; transition: background 0.3s; display: inline-block; text-align: center; text-decoration: none; }
        .btn-green { background-color: var(--accent-green); color: white; width: 100%; margin-top: 20px; }
        .btn-blue { background-color: var(--accent-blue); color: white; }
        .btn-gray { background-color: #6c757d; color: white; }

        /* --- LABEL CARD --- */
        .label-card { border: 3px solid black; border-radius: 15px; padding: 20px; margin: 0 auto 20px auto; text-align: left; background: white; color: black; max-width: 450px; position: relative; }
        .label-big { font-size: 24px; font-weight: 900; color: black; margin-left: 5px; }
        .label-big-wrap { display: flex; align-items: baseline; width: 100%; margin-bottom: 8px; border-bottom: 1px dashed #ccc; padding-bottom: 5px; }
        
        .link-result-box { margin-top: 20px; padding: 15px; background: #e9ecef; border-radius: 6px; word-break: break-all; text-align: center; display: none; }

        /* --- MODALS --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-overlay.open { display: flex; }
        .modal-box { background: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 400px; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideDown { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        @media print {
            body * { visibility: hidden; }
            #label-card-print, #label-card-print * { visibility: visible; }
            #label-card-print { position: absolute; left: 0; top: 0; width: 100%; border: 3px solid black !important; }
        }
    </style>
</head>
<body>

    <div id="view-home" class="container">
        <div style="text-align: center; padding: 50px 20px;">
            <div style="font-size: 26px; color: var(--accent-blue); margin-bottom: 15px;">U New Technology Software jste správně</div>
            <p>Zadejte platnou adresu nebo přejděte do administrace.</p>
            <a href="#admin-main" class="btn btn-blue">Přejít do administrace</a>
        </div>
    </div>

    <div id="view-admin" class="container">
        <h1>Administrace zásilek</h1>
        <hr>
        <div class="form-group">
            <label>Kurýrní společnost:</label>
            <div class="custom-select-wrapper" id="sel-courier">
                <input type="text" id="courier-input" readonly placeholder="Vyberte kurýra" class="custom-select-trigger">
                <div id="courier-options" class="custom-options"></div>
            </div>
        </div>
        <div class="form-group">
            <label>Typ doručení:</label>
            <div class="custom-select-wrapper" id="sel-type">
                <input type="text" id="type-input" readonly placeholder="Vyberte typ doručení" class="custom-select-trigger">
                <div id="type-options" class="custom-options"></div>
            </div>
        </div>

        <div id="section-address-time" class="section-hidden">
            <div class="form-group"><label>Datum doručení:</label><input type="date" id="addr-date"></div>
            <div id="addr-time-block">
                <div class="form-group">
                    <label>Čas od - do:</label>
                    <div style="display:flex; gap:10px;"><input type="time" id="addr-time-from"> <input type="time" id="addr-time-to"></div>
                </div>
            </div>
            <div class="checkbox-wrapper"><input type="checkbox" id="no-time-check"> <label for="no-time-check">Čas neupřesněn</label></div>
        </div>

        <div id="section-pickup-time" class="section-hidden">
            <div class="form-group"><label>Vyzvednout do:</label><input type="date" id="pickup-date"></div>
        </div>

        <div id="section-final-details" class="section-hidden">
            <hr>
            <div class="form-group"><label>ID objednávky / Balíku:</label><input type="text" id="order-id"></div>
            <div class="form-group"><label>PIN kód:</label><input type="text" id="pin-code"></div>
            <div class="form-group"><label>Telefon na balíku:</label><input type="text" id="phone-num"></div>
            <div class="form-group"><label>Jméno příjemce:</label><input type="text" id="recipient-name"></div>
            <div class="form-group"><label>Poznámka:</label><input type="text" id="internal-note"></div>
            <div class="form-group">
                <label>Dobírka:</label>
                <input type="text" id="cod-price" placeholder="Kč">
                <div class="checkbox-wrapper"><input type="checkbox" id="cod-paid"> <label for="cod-paid">Uhrazeno (0 Kč)</label></div>
            </div>
            <button class="btn btn-green" id="btn-generate">Zobrazit náhled</button>
        </div>
    </div>

    <div id="view-label" class="container">
        <h1>Štítek zásilky</h1>
        <div id="label-card-print" class="label-card">
            <div style="font-size:13px;"><strong id="lbl-courier"></strong> - <span id="lbl-type"></span></div>
            <div class="label-big-wrap" style="margin-top:10px;"><span>Balík:</span><span class="label-big" id="lbl-order"></span></div>
            <div class="label-big-wrap"><span>PIN:</span><span class="label-big" id="lbl-pin"></span></div>
            <div style="margin-top:10px; font-weight: bold;" id="lbl-date-text"></div>
            <div style="margin-top:10px; font-size:13px;">Příjemce: <strong id="lbl-recipient"></strong></div>
            <div style="font-size:13px;">Tel: <strong id="lbl-phone"></strong></div>
            <div id="lbl-note-display" style="font-size:12px; color:#555;"></div>
            <div style="margin-top:10px; border-top: 2px solid #eee; padding-top:5px;">Dobírka: <span class="label-big" id="lbl-cod"></span></div>
        </div>

        <div id="action-area" style="text-align:center;">
            <button class="btn btn-green" onclick="window.print()">Vytisknout štítek</button>
            <button id="btn-save" class="btn btn-blue" style="margin-top:10px;">Uložit do databáze a sdílet</button>
            <div id="link-result" class="link-result-box">
                <strong>Odkaz pro sdílení:</strong><br><span id="generated-link" style="color:#007bff; font-size:12px; font-weight:bold;"></span><br>
                <button id="btn-copy" class="btn btn-blue" style="padding:5px 10px; font-size:12px; margin-top:5px;">Zkopírovat odkaz</button>
            </div>
        </div>
        <button class="btn btn-gray" style="margin-top:20px; width:100%" onclick="window.location.hash=''; window.location.reload();">Zpět na začátek</button>
    </div>

    <div id="modal-other" class="modal-overlay"><div class="modal-box"><h3>Vlastní údaj</h3><input type="text" id="modal-other-input" style="width:100%; padding:10px;"><div style="margin-top:15px; display:flex; gap:10px;"><button class="btn btn-gray" onclick="document.querySelector('.modal-overlay').classList.remove('open')">Zpět</button><button class="btn btn-green" id="btn-other-confirm">Potvrdit</button></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, push, get, child } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB7ss5yYyswMgeh7QBtbmNAG7_DAZEjlIg",
            authDomain: "stitky-zasilky-vyzvednout.firebaseapp.com",
            databaseURL: "https://stitky-zasilky-vyzvednout-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "stitky-zasilky-vyzvednout",
            storageBucket: "stitky-zasilky-vyzvednout.firebasestorage.app",
            messagingSenderId: "495288570389",
            appId: "1:495288570389:web:f25a393cf94855c4b6341c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const state = { courier: "", deliveryPlace: "", isAddress: false, currentLabelData: null };
        const COURIERS = ["Zásilkovna", "Balíkovna", "Česká pošta", "PPL", "DPD", "Alza", "Jiné"];
        const TYPES = ["DZ Oil Dub nad Moravou", "GigaComputer Olomouc", "Pošta Šantovka", "AlzaBox Šantovka", "Na adresu", "Jiné"];

        // Spuštění po načtení
        window.addEventListener('load', handleRouting);
        window.addEventListener('hashchange', handleRouting);

        function handleRouting() {
            const hash = window.location.hash;
            document.querySelectorAll('.container').forEach(c => c.classList.remove('active-view'));

            if (hash.includes('id-')) {
                const id = hash.split('id-')[1];
                loadLabel(id);
            } else if (hash.includes('admin-main')) {
                document.getElementById('view-admin').classList.add('active-view');
                initAdmin();
            } else {
                document.getElementById('view-home').classList.add('active-view');
            }
        }

        function loadLabel(id) {
            const tryFetch = (targetId) => {
                get(child(ref(db), `labels/${targetId}`)).then((snap) => {
                    if (snap.exists()) {
                        renderLabel(snap.val());
                        document.getElementById('view-label').classList.add('active-view');
                        document.getElementById('btn-save').style.display = 'none';
                    } else if (!targetId.startsWith('-')) {
                        tryFetch('-' + targetId);
                    } else {
                        document.getElementById('view-home').classList.add('active-view');
                    }
                });
            };
            tryFetch(id);
        }

        function renderLabel(data) {
            document.getElementById('lbl-courier').innerText = data.courier;
            document.getElementById('lbl-type').innerText = data.placeText;
            document.getElementById('lbl-order').innerText = data.orderId;
            document.getElementById('lbl-pin').innerText = data.pin;
            document.getElementById('lbl-date-text').innerText = data.dateText;
            document.getElementById('lbl-recipient').innerText = data.recipient;
            document.getElementById('lbl-phone').innerText = data.phone;
            document.getElementById('lbl-cod').innerText = data.cod;
            document.getElementById('lbl-note-display').innerText = data.note ? "Poznámka: " + data.note : "";
        }

        function initAdmin() {
            // Dropdowny
            setupDropdown('courier-options', COURIERS, 'courier-input', (v) => { state.courier = v; checkProg(); });
            setupDropdown('type-options', TYPES, 'type-input', (v) => { 
                state.deliveryPlace = v; 
                state.isAddress = (v === 'Na adresu');
                checkProg(); 
            });

            document.getElementById('btn-generate').onclick = () => {
                const data = {
                    courier: state.courier,
                    placeText: state.deliveryPlace,
                    orderId: document.getElementById('order-id').value,
                    pin: document.getElementById('pin-code').value,
                    phone: document.getElementById('phone-num').value,
                    recipient: document.getElementById('recipient-name').value,
                    note: document.getElementById('internal-note').value,
                    cod: document.getElementById('cod-paid').checked ? "0 Kč (Uhrazeno)" : document.getElementById('cod-price').value + " Kč",
                    dateText: state.isAddress ? "Doručení: " + document.getElementById('addr-date').value : "Uloženo do: " + document.getElementById('pickup-date').value
                };
                state.currentLabelData = data;
                renderLabel(data);
                document.getElementById('view-admin').classList.remove('active-view');
                document.getElementById('view-label').classList.add('active-view');
                document.getElementById('btn-save').style.display = 'inline-block';
            };

            document.getElementById('btn-save').onclick = () => {
                const btn = document.getElementById('btn-save');
                btn.innerText = "Ukládám...";
                const newRef = push(ref(db, 'labels'));
                set(newRef, state.currentLabelData).then(() => {
                    const cleanId = newRef.key.replace(/^-/, '');
                    const url = window.location.origin + window.location.pathname + "#id-" + cleanId;
                    document.getElementById('generated-link').innerText = url;
                    document.getElementById('link-result').style.display = 'block';
                    btn.innerText = "Uloženo v DB";
                });
            };

            document.getElementById('btn-copy').onclick = () => {
                navigator.clipboard.writeText(document.getElementById('generated-link').innerText);
                alert("Odkaz zkopírován!");
            };
        }

        function setupDropdown(id, opts, inputId, cb) {
            const container = document.getElementById(id);
            if (container.children.length > 0) return;
            opts.forEach(o => {
                const d = document.createElement('div');
                d.className = 'custom-option'; d.innerText = o;
                d.onclick = () => {
                    if (o === 'Jiné') {
                        document.getElementById('modal-other').classList.add('open');
                        document.getElementById('btn-other-confirm').onclick = () => {
                            const val = document.getElementById('modal-other-input').value;
                            document.getElementById(inputId).value = val;
                            cb(val);
                            document.getElementById('modal-other').classList.remove('open');
                        };
                    } else {
                        document.getElementById(inputId).value = o;
                        cb(o);
                    }
                };
                container.appendChild(d);
            });
            document.getElementById(inputId).onclick = (e) => {
                e.stopPropagation();
                container.classList.toggle('open');
            };
            document.addEventListener('click', () => container.classList.remove('open'));
        }

        function checkProg() {
            if(state.courier && state.deliveryPlace) {
                document.getElementById('section-address-time').style.display = state.isAddress ? 'block' : 'none';
                document.getElementById('section-pickup-time').style.display = state.isAddress ? 'none' : 'block';
                document.getElementById('section-final-details').classList.add('section-visible');
            }
        }
    </script>
</body>
</html>
